# coding=utf-8
# @Author   : zpchcbd HG team
# @Time     : 2021-09-02 22:30

from tqdm import tqdm

from core.utils.InformationProvider import InformationProvider
from exploit.public import *
from exploit import BaseExploit

from exploit.service.dubbo import dubboScan
from exploit.service.ftp import ftpScan
from exploit.service.ldap import ldapScan
from exploit.service.jdwp import jdwpScan
from exploit.service.log4j import log4jScan
from exploit.service.memcache import memcacheScan
from exploit.service.mongodb import mongodbScan
from exploit.service.mssql import mssqlScan
from exploit.service.mysql import mysqlScan
from exploit.service.postgresql import postgresqlScan
from exploit.service.rdp import rdpScan
from exploit.service.redis import redisScan
from exploit.service.rmi import rmiScan
from exploit.service.rsync import rsyncScan
from exploit.service.smb import smbScan
from exploit.service.ssh import sshScan
from exploit.service.proxy import proxyScan
# from exploit.service.vnc import vncScan
from exploit.service.zookeeper import zookeeperScan


class PortServiceScan(BaseExploit):

    def __init__(self, domain, portServiceList, pbar):
        super().__init__()
        self.source = 'PortServiceScan'
        self.domain = domain
        self.portServiceList = portServiceList
        self.pbar = pbar

    def scan(self):
        pass

    async def exploit(self):
        #     # self.portServiceList = [
        #     # {'service': 'redis', 'ip': ['1.1.1.1:6379','2.2.2.2:9874']},
        #     # {'service': 'rsync', 'ip': ['3.3.3.3:873','4.4.4.4:783'], }
        #     # ]
        redisPasswordList = InformationProvider.readFile(
            os.path.join(InformationProvider.dictPath, 'redis_passwords.txt'))

        ftpUsernameList = InformationProvider.readFile(
            os.path.join(InformationProvider.dictPath, 'ftp_usernames.txt'))
        ftpPasswordList = InformationProvider.readFile(
            os.path.join(InformationProvider.dictPath, 'ftp_passwords.txt'))
        ftpUPList = InformationProvider.generate(ftpUsernameList, ftpPasswordList)

        mysqlUsernameList = InformationProvider.readFile(
            os.path.join(InformationProvider.dictPath, 'mysql_usernames.txt'))
        mysqlPasswordList = InformationProvider.readFile(
            os.path.join(InformationProvider.dictPath, 'mysql_passwords.txt'))
        mysqlUPList = InformationProvider.generate(mysqlUsernameList, mysqlPasswordList)

        mssqlUsernameList = InformationProvider.readFile(
            os.path.join(InformationProvider.dictPath, 'sqlserver_usernames.txt'))
        mssqlPasswordList = InformationProvider.readFile(
            os.path.join(InformationProvider.dictPath, 'sqlserver_passwords.txt'))
        mssqlUPList = InformationProvider.generate(mssqlUsernameList, mssqlPasswordList)

        postgreUsernameList = InformationProvider.readFile(
            os.path.join(InformationProvider.dictPath, 'postgresql_usernames.txt'))
        postgrePasswordList = InformationProvider.readFile(
            os.path.join(InformationProvider.dictPath, 'postgresql_passwords.txt'))
        postgreUPList = InformationProvider.generate(postgreUsernameList, postgrePasswordList)

        rsyncUsernameList = InformationProvider.readFile(
            os.path.join(InformationProvider.dictPath, 'rsync_usernames.txt'))
        rsyncPasswordList = InformationProvider.readFile(
            os.path.join(InformationProvider.dictPath, 'rsync_passwords.txt'))
        rsyncUPList = InformationProvider.generate(rsyncUsernameList, rsyncPasswordList)

        sshUsernameList = InformationProvider.readFile(
            os.path.join(InformationProvider.dictPath, 'ssh_usernames.txt'))
        sshPasswordList = InformationProvider.readFile(
            os.path.join(InformationProvider.dictPath, 'ssh_passwords.txt'))
        sshUPList = InformationProvider.generate(sshUsernameList, sshPasswordList)

        # semaphore = asyncio.Semaphore(500)

        serviceTaskList = []
        for target in self.portServiceList:
            targetService = target['service']
            if 'textui' in targetService:
                # textui == dubbo
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(dubboScan(_, pbar)))
            elif 'ftp' in targetService:
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(ftpScan(_, ftpUPList, pbar)))
            elif 'jdwp' in targetService:
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(jdwpScan(_, pbar)))
            elif 'log4j' in targetService:
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(log4jScan(_, pbar)))
            elif 'memcache' in targetService:
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(memcacheScan(_, pbar)))
            elif 'mongodb' in targetService:
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(mongodbScan(_, pbar)))
            elif 'ms-sql-s' in targetService:
                # mssql
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(mssqlScan(_, mssqlUPList, pbar)))
            elif 'mysql' in targetService:
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(mysqlScan(_, mysqlUPList, pbar)))
            elif 'postgresql' in targetService:
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(postgresqlScan(_, postgreUPList, pbar)))
            elif 'ms-wbt-server' in targetService:
                # rdp
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(rdpScan(_, pbar)))
            elif 'ldap' in targetService:
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(ldapScan(_, pbar)))
            elif 'redis' in targetService:
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(redisScan(_, redisPasswordList, pbar)))
            elif 'rmi' in targetService:
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(rmiScan(_, pbar)))
            elif 'microsoft-ds' in targetService:
                # smb
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(smbScan(_, pbar)))
            elif 'rsync' in targetService:
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(rsyncScan(_, rsyncUPList, pbar)))
            elif 'ssh' in targetService:
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(sshScan(_, sshUPList, pbar)))
            elif 'zookeeper' in targetService:
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(zookeeperScan(_, pbar)))
            elif 'proxy' in targetService:
                for _ in target['ip']:
                    serviceTaskList.append(asyncio.create_task(proxyScan(_, pbar)))
            elif 'http' in targetService:
                # http的处理已经在前面portSpider中进行处理了，全部重新放到self.domainList中去进行CmsScan利用
                pass
        # 数据处理
        result = await asyncio.gather(*serviceTaskList)  # [[{}],[{}]]
        for i in result:
            for _ in i:
                self.resList.append(_)
        print('[+] [{}] [{}] {}'.format(self.source, len(self.resList), self.resList))
        # self.writeFile(self.resList, 12)

    async def main(self):
        await self.exploit()


if __name__ == '__main__':
    portServiceList = [{'service': 'microsoft-ds', 'ip': ['127.0.0.1:445']}]
    total = 0
    for targetService in portServiceList:
        total += len(targetService['ip'])
    pbar = tqdm(total=total, desc="ServiceScan", ncols=100)  # total是总数
    p = PortServiceScan('asd', portServiceList, pbar)
    loop = asyncio.get_event_loop()
    loop.run_until_complete(p.main())

    # starttime = time.time()
    # list_ = ['172.30.212.58']
    # queue = asyncio.Queue(-1)
    # xxx = IpUnauth('nbcc.cn', queue)
    #
    # print(time.time() - starttime)
