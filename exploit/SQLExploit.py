# coding=utf-8

from exploit.public import *
from exploit import BaseExploit

import subprocess
import time

absPython = os.path.join(os.getcwd(), 'lib\python.exe')
absSqlmap = os.path.join(os.getcwd(), 'lib\sqlmap\\')
os_run = absPython + ' ' + absSqlmap


class SqlScan(BaseExploit):

    def __init__(self, domain, webParamsList):
        super().__init__()
        self.source = 'SqlScan'
        self.domain = domain
        self.webParamsList = webParamsList

    def exploit(self):
        pass

    def main(self):
        pass

    # 主函数
    def get_url_sql(self, url, level=1):
        link = self.getLinks(url).get_links()  # 爬取当前网站存在参数的url
        html_links = link.get('html_links')
        id_links = link.get('id_links')
        if link == None:
            pass
        else:
            if html_links:
                for html_link in html_links:
                    dix = self.scan_html(html_link, level)
                    if dix == 'INJ':
                        return
            if id_links:
                for id_link in id_links:
                    if level == 0:
                        dix = self.scan_level_0(id_link.strip())  # 开始扫描
                        if dix == 'INJ':  # 返回值INJ的话那么说明存在SQL注入
                            return

    def scan_level_0(self, url):
        """
        :rtype: object
        """
        url = url.replace('&', '^&')
        comm = 'python2 sqlmap.py -u %s --technique B --batch --thread=10 --random-agent' % url
        print('Level 0 : ' + url.replace('^', '').replace('*', ''))
        self.writedata(comm)
        try:
            res = subprocess.Popen(comm, shell=True, stdout=subprocess.PIPE)
            result = res.stdout.read().decode()
            self.writedata(result)
            inj = self.check(result, url=url, common=comm)
        except Exception as e:
            self.writedata('[WARNING ERROR]' + str(e))
            pass
        finally:
            res.terminate()
            return inj

    def scan_html(self, url, level):
        urlse = url.replace('.htm', '*.htm').replace('.shtm', '*.shtm')
        urls = urlse.replace('&', '^&')
        if level == 1 or level == 2 or level == 0:
            comm = os_run + \
                   'sqlmap.py -u {} --batch --thread=10 --random-agent'.format(urls)
            if level == 1:
                print('Level 1 : ' + urls.replace('^', '').replace('*', ''))
            if level == 2:
                print('Level 2 : ' + urls.replace('^', '').replace('*', ''))
            if level == 0:
                print('Level 0 : ' + urls.replace('^', '').replace('*', ''))

        if level == 3 or level == 4 or level == 6:
            comm = os_run + 'sqlmap.py -u %s --batch --tamper space2comment.py --thread=10 --random-agent' % urls
            if level == 3:
                print('Level 3 : ' + urls.replace('^', '').replace('*', ''))
            if level == 4:
                print('Level 4 : ' + urls.replace('^', '').replace('*', ''))
            if level == 6:
                print('Level 6 : ' + urls.replace('^', '').replace('*', ''))
        if level == 5:
            comm = os_run + 'sqlmap.py -u {} --batch --tamper space2comment.py --delay 2 --time-sec=15 --timeout=20  --level 5 --thread=10 --random-agent'.format(
                urls)
            print('Level 5 : ' + urls.replace('^', '').replace('*', ''))
        self.writedata(comm)

        try:
            res = subprocess.Popen(comm, shell=True, stdout=subprocess.PIPE)
            result = res.stdout.read().decode()
            self.writedata(result)
            inj = self.check(result, url=url, common=comm)  # 输出的内容进行匹配check是否存在注入
        except Exception as e:
            self.writedata('[WARNING ERROR]' + str(e))
            pass
        finally:
            res.terminate()
            return inj

    def check(self, result, url, common, ):
        url = url.replace('^', '')
        if '---' in result:
            domain_values = "1111"
            if 'sqlmap was not able to fingerprint the back-end database management syste' not in result:
                try:
                    result_info = re.search('---(.*?)---.*?\[INFO\] (the back-end DBMS is .*?)\[', result, re.S)
                    inj = result_info.group(1)
                    dbs = result_info.group(2)
                    with open('LAnGZi_SQL_Injection_Report.html', 'a+', encoding='utf-8') as ae:
                        ae.write('''
                        <div class="col-md-12 font-weight-bold"><br>
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                网站漏洞报表
                            </div>
                            <div class="panel-body">
                                <table class="table">

                                    <tr>
                                        <td>发现时间</td>
                        <td>{}</td>
                    </tr>


                    <tr>
                        <td>网站标题</td>
                        <td>{}</td>
                    </tr>


                    <tr>
                        <td>注入网址</td>
                        <td>{}</td>
                    </tr>
                    <tr>
                        <td>执行命令</td>
                        <td>{}</td>
                    </tr>
                    '''.format(str(time.strftime('%Y-%m-%d:%H:%M:%S', time.localtime())),
                               domain_values.get('网站标题'),
                               url,
                               common
                               ))

                        ae.write(inj.replace('Parameter: ', '<tr><td>注入参数(方式)</td><td> ').replace('Type: ',
                                                                                                  '</td></tr><tr class="active"><td>&nbsp;&nbsp;&nbsp;&nbsp;注入方式</td><td>').replace
                                 ('Title: ', '</td></tr><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;注入标题</td><td>').replace(
                            'Payload: ', '</td></tr><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;注入攻击</td><td>') + '</td></tr>')

                        if 'back-end DBMS' in dbs:
                            ae.write(dbs.replace('the back-end DBMS is ', '<tr><td>数据库类型</td><td> ').replace(
                                'web server operating system: ', '</td></tr><tr><td>服务器版本</td><td>').replace(
                                'web application technology: ', '</td></tr><tr><td>服务器语言</td><td>').replace(
                                'back-end DBMS: ', '</td></tr><tr><td>数据库版本</td><td>') + '</td></tr>')


                        else:
                            ae.write('''
                         <tr>
                            <td>出现拦截</td>
                            <td>可能存在注入但被拦截,或者无法识别数据库版本</td>
                        </tr>
                            ''')
                        ae.write('''
                        </table>
            </div>


            <div class="panel-footer">
                网站信息报表
            </div>

            <div class="panel-body">

                <table class="table">

                    <tr>
                        <td>百度权重</td>
                        <td>{}</td>
                    </tr>
                    <tr>
                        <td>网站主页</td>
                        <td>{}</td>
                    </tr>
                    <tr>
                        <td>网站标题</td>
                        <td>{}</td>
                    </tr>
                    <tr>
                        <td>IP__坐标</td>
                        <td>{}</td>
                    </tr>
                    <tr>
                        <td>所属__IP</td>
                        <td>{}</td>
                    </tr>
                    <tr>
                        <td>网站年龄</td>
                        <td>{}</td>
                    </tr>
                    <tr>
                        <td>备案编号</td>
                        <td>{}</td>
                    </tr>
                    <tr>
                        <td>备案性质</td>
                        <td>{}</td>
                    </tr>
                    <tr>
                        <td>备案名称</td>
                        <td>{}</td>
                    </tr>
                    <tr>
                        <td>备案时间</td>
                        <td>{}</td>
                    </tr>
                    <tr>
                        <td>百度收录</td>
                        <td>{}</td>
                    </tr>
                    <tr>
                        <td>协议类型</td>
                        <td>{}</td>
                    </tr>
                    <tr>
                        <td>页面类型</td>
                        <td>{}</td>
                    </tr>
                    <tr>
                        <td>服务类型</td>
                        <td>{}</td>
                    </tr>
                    <tr>
                        <td>程序语言</td>
                        <td>{}</td>
                                    </tr>
                                </table>

                            </div>

                        </div>
                    </div>


                        '''.format(domain_values.get('百度权重'),
                                   domain_values.get('网站主页'),
                                   domain_values.get('网站标题'),
                                   domain_values.get('IP__坐标'),
                                   domain_values.get('所属__IP'),
                                   domain_values.get('网站年龄'),
                                   domain_values.get('备案编号'),
                                   domain_values.get('备案性质'),
                                   domain_values.get('备案名称'),
                                   domain_values.get('备案时间'),
                                   domain_values.get('百度收录'),
                                   domain_values.get('协议类型'),
                                   domain_values.get('页面类型'),
                                   domain_values.get('服务类型'),
                                   domain_values.get('程序语言')))

                        # with open('result.txt', 'a+', encoding='utf-8') as ae:
                        #     ae.write('-------------------------------------------------\n')
                        #     ae.write('发现时间 : ' + str(time.strftime('%Y-%m-%d:%H:%M:%S', time.localtime())) + '\n')
                        #     ae.write('网站标题 : ' + title + '\n')
                        #     ae.write('注入网址 : ' + url + '\n')
                        #     ae.write('执行命令 : ' + common + '\n')
                        #     ae.write(inj.replace('Parameter: ', '注入参数(方式) : ').replace('Type: ', '注入方式 : ').replace('Title: ',
                        #                                                                                             '注入标题 : ').replace(
                        #         'Payload: ', '注入攻击 : ') + '\n')
                        #     if 'back-end DBMS' in dbs:
                        #         ae.write(
                        #             dbs.replace('the back-end DBMS is ', '数据库类型 : ').replace('web server operating system: ',
                        #                                                                      '服务器版本 : ').replace(
                        #                 'web application technology: ', '服务器语言 : ').replace('back-end DBMS: ',
                        #                                                                     '数据库版本 : ') + '\n')
                        #     else:
                        #         ae.write('\n' + '可能存在注入但被拦截,或者无法识别数据库版本' + '\n')

                        return 'INJ'
                except Exception as e:
                    pass


            else:
                try:
                    result_info = re.search('---(.*?)---.*?INFO\] (.*?)\[', result, re.S)
                    inj = result_info.group(1)
                    with open('LAnGZi_SQL_Injection_Report.html', 'a+', encoding='utf-8') as ae:
                        ae.write('''
                                <div class="col-md-12 font-weight-bold"><br>
                                <div class="panel panel-primary">
                                    <div class="panel-heading">
                                        网站漏洞报表
                                    </div>
                                    <div class="panel-body">
                                        <table class="table">

                                            <tr>
                                                <td>发现时间</td>
                                <td>{}</td>
                            </tr>


                            <tr>
                                <td>网站标题</td>
                                <td>{}</td>
                            </tr>


                            <tr>
                                <td>注入网址</td>
                                <td>{}</td>
                            </tr>
                            <tr>
                                <td>执行命令</td>
                                <td>{}</td>
                            </tr>
                            '''.format(str(time.strftime('%Y-%m-%d:%H:%M:%S', time.localtime())),
                                       domain_values.get('网站标题'),
                                       url,
                                       common
                                       ))

                        ae.write(inj.replace('Parameter: ', '<tr><td>注入参数(方式)</td><td> ').replace('Type: ',
                                                                                                  '</td></tr><tr class="active"><td>注入方式</td><td>').replace
                                 ('Title: ', '</td></tr><tr><td>注入标题</td><td>').replace(
                            'Payload: ', '</td></tr><tr><td>注入攻击</td><td>') + '</td></tr>')

                        ae.write('''
                         <tr>
                            <td>出现拦截</td>
                            <td>可能存在注入但被拦截,或者无法识别数据库版本</td>
                        </tr>
                            ''')
                        ae.write('''
                                </table>
                    </div>


                    <div class="panel-footer">
                        网站信息报表
                    </div>

                    <div class="panel-body">

                        <table class="table">

                            <tr>
                                <td>百度权重</td>
                                <td>{}</td>
                            </tr>
                            <tr>
                                <td>网站主页</td>
                                <td>{}</td>
                            </tr>
                            <tr>
                                <td>网站标题</td>
                                <td>{}</td>
                            </tr>
                            <tr>
                                <td>IP__坐标</td>
                                <td>{}</td>
                            </tr>
                            <tr>
                                <td>所属__IP</td>
                                <td>{}</td>
                            </tr>
                            <tr>
                                <td>网站年龄</td>
                                <td>{}</td>
                            </tr>
                            <tr>
                                <td>备案编号</td>
                                <td>{}</td>
                            </tr>
                            <tr>
                                <td>备案性质</td>
                                <td>{}</td>
                            </tr>
                            <tr>
                                <td>备案名称</td>
                                <td>{}</td>
                            </tr>
                            <tr>
                                <td>备案时间</td>
                                <td>{}</td>
                            </tr>
                            <tr>
                                <td>百度收录</td>
                                <td>{}</td>
                            </tr>
                            <tr>
                                <td>协议类型</td>
                                <td>{}</td>
                            </tr>
                            <tr>
                                <td>页面类型</td>
                                <td>{}</td>
                            </tr>
                            <tr>
                                <td>服务类型</td>
                                <td>{}</td>
                            </tr>
                            <tr>
                                <td>程序语言</td>
                                <td>{}</td>
                                            </tr>
                                        </table>

                                    </div>

                                </div>
                            </div>


                                '''.format(domain_values.get('百度权重'),
                                           domain_values.get('网站主页'),
                                           domain_values.get('网站标题'),
                                           domain_values.get('IP__坐标'),
                                           domain_values.get('所属__IP'),
                                           domain_values.get('网站年龄'),
                                           domain_values.get('备案编号'),
                                           domain_values.get('备案性质'),
                                           domain_values.get('备案名称'),
                                           domain_values.get('备案时间'),
                                           domain_values.get('百度收录'),
                                           domain_values.get('协议类型'),
                                           domain_values.get('页面类型'),
                                           domain_values.get('服务类型'),
                                           domain_values.get('程序语言')))
                        # with open('result.txt', 'a+', encoding='utf-8') as ae:
                        #     ae.write('-------------------------------------------------\n')
                        #     ae.write('发现时间 : ' + str(time.strftime('%Y-%m-%d:%H:%M:%S', time.localtime())) + '\n')
                        #     ae.write('网站标题 : ' + title + '\n')
                        #     ae.write('注入网址 : ' + url + '\n')
                        #     ae.write('执行命令 : ' + common + '\n')
                        #     ae.write(inj.replace('Parameter: ', '注入参数(方式) : ').replace('Type: ', '注入方式 : ').replace('Title: ',
                        #                                                                                             '注入标题 : ').replace(
                        #         'Payload: ', '注入攻击 : ') + '\n')
                        #     ae.write('\n' + '存在注入但无法识别数据库版本' + '\n')
                        return 'INJ'
                except Exception as e:
                    writedata('[WARNING ERROR]' + str(e))


if __name__ == '__main__':
    pass
