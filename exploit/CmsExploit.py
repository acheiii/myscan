# coding=utf-8
# @Author   : zpchcbd HG team
# @Time     : 2021-09-02 22:30

from exploit.public import *
from exploit import BaseExploit
from tqdm import tqdm


class CmsScan(BaseExploit):

    def __init__(self, domain, domainList, moduleList):
        super().__init__()
        self.source = 'CmsScan'
        self.domain = domain
        self.domainList = domainList
        self.moduleList = moduleList

    async def exploit(self):
        for module in self.moduleList:
            taskList = []
            semaphore = asyncio.Semaphore(500)
            pbar = tqdm(total=len(self.domainList), desc=module.name, ncols=100)  # total是总数
            for domain in self.domainList:
                aObject = module(domain, pbar, semaphore)
                taskList.append(asyncio.create_task(aObject.attack()))
            result = await asyncio.gather(*taskList)
            for r in result:
                for _ in r:
                    self.resList.append(_)
            print('[+] [{}] [{}] {}'.format(module.name, len(self.resList), self.resList))
        # self.writeFile(resList, 12)

    async def main(self):
        await self.exploit()


if '__main__' == __name__:
    pass
    # a = CmsScan('', 'http://news.eeeqi.cn/')
    # thread_list = []
    # thread_list.append(Thread(target=a.header_index_content_scan, args=()))
    # thread_list.append(Thread(target=a.robot_scan, args=()))
    # thread_list.append(Thread(target=a.frame_scan, args=()))
    # # thread_list.append(Thread(target=a.sub_dir_content_scan, args=()))
    # # thread_list.append(Thread(target=a.md5_scan, args=()))
    #
    # for t in thread_list:
    #     t.start()
    # for t in thread_list:
    #     t.join()
