# coding=utf-8
# @Author   : zpchcbd HG team
# @Time     : 2021-08-27 18:36
from async_timeout import timeout

from exploit.service.base import *


async def rsyncScan(addr):
    try:
        with timeout(1):
            reader, writer = await asyncio.open_connection(addr.split(':')[0], int(addr.split(':')[1]))
            writer.write(b'@RSYNCD: 31\n')
            await writer.drain()
            result = await reader.read(1024)
            for path_name in re.split('\n', result.decode()):
                if path_name and not path_name.startswith('@RSYNCD: '):
                    return True, {'name': 'unauth', 'url': str(addr), 'software': 'rsync'}
    except:
        return False, ''
    finally:
        writer.close()
