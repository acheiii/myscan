# coding=utf-8
# @Author   : zpchcbd HG team
# @Time     : 2021-09-02 22:05

from async_timeout import timeout
import asyncio
from tqdm import tqdm


async def checkDeserialization(addr):
    try:
        with timeout(5):
            reader, writer = await asyncio.open_connection(addr.split(':')[0], int(addr.split(':')[1]))
            writer.write(b'log4j\r\n')
            await writer.drain()
            result = await reader.read()
            print(result)
            if b"STAT version" in result:
                return {'name': 'deserialization', 'url': addr, 'software': 'log4j'}
    except Exception:
        pass
    finally:
        try:
            writer.close()
        except NameError:
            pass


# log4j 反序列化
async def log4jScan(addr, pbar):
    vulList = []
    a = await checkDeserialization(addr)
    if a is not None:
        vulList.append(a)
    pbar.update(1)
    return vulList

if __name__ == '__main__':
    pbar = tqdm(total=1, desc='[{test}]', ncols=100)  # total是总数
    loop = asyncio.get_event_loop()
    loop.run_until_complete(log4jScan('127.0.0.1:4560', pbar))
