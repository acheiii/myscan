# coding=utf-8
# @Author   : zpchcbd HG team
# @Time     : 2021-09-02 22:05
from async_timeout import timeout
from colorama import Fore
from tqdm import tqdm
import aiomysql


async def checkWeakpass(addr, mysqlUPList):
    for username, password in mysqlUPList:
        try:
            with timeout(10):
                conn = await aiomysql.connection.connect(host=addr.split(':')[0], user=username, password=password, db=None, port=int(addr.split(':')[1]))
                if conn:
                    conn.close()
                    tqdm.write(Fore.RED + '[+] target maybe mysql weakpass, {}'.format(
                        str(addr) + ' | ' + str(username) + '/' + str(password)))
                    return {'name': 'weakpass', 'url': str(addr) + ' | ' + str(username) + '/' + str(password),
                            'software': 'mysql'}
        # ValueError
        except(ValueError, IndexError):
            return
        except Exception:
            pass
        finally:
            try:
                conn.close()
            except NameError:
                pass


async def mysqlScan(addr, mysqlUPList, pbar):
    vulList = []
    a = await checkWeakpass(addr, mysqlUPList)
    if a is not None:
        vulList.append(a)
    pbar.update(1)
    return vulList
