# coding=utf-8
# @Author   : zpchcbd HG team
# @Time     : 2021-09-02 15:29
from colorama import Fore
from tqdm import tqdm
import aioftp as aioftp
from async_timeout import timeout


async def checkWeakPass(addr, ftpUPList):
    # 有可能存在匿名登录的情况 username:anonymous
    anonymousFlag = False
    for username, password in ftpUPList:
        try:
            with timeout(60):
                if not anonymousFlag:
                    if username == 'anonymous':
                        anonymousFlag = True
                else:
                    continue
                # await aioftp.Client.login()
                async with aioftp.Client.context(addr.split(':')[0], addr.split(':')[1], username, password) as client:
                    tqdm.write(Fore.RED + '[+] target maybe ftp weakpass, {}'.format(str(addr) + ' | ' + str(username) + '/' + str(password)))
                    return {'name': 'weakpass', 'url': str(addr) + ' | ' + str(username) + '/' + str(password), 'software': 'ftp'}
        except Exception:
            pass
        finally:
            try:
                client.close()
            except NameError:
                pass


async def ftpScan(addr, ftpUPList, pbar):
    vulList = []
    a = await checkWeakPass(addr, ftpUPList)
    if a is not None:
        vulList.append(a)
    pbar.update(1)
    return vulList


if __name__ == '__main__':
    pass
