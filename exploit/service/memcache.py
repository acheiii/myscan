# coding=utf-8
# @Author   : zpchcbd HG team
# @Time     : 2021-08-27 18:34
from async_timeout import timeout

from colorama import Fore
from tqdm import tqdm
import asyncio

# from exploit.service.base import *



async def checkUnauth(addr):
    try:
        with timeout(5):
            reader, writer = await asyncio.open_connection(addr.split(':')[0], int(addr.split(':')[1]))
            writer.write(b'stats\r\n')
            await writer.drain()
            result = await reader.read(1024)
            if b"STAT version" in result:
                # print('[+] target maybe memcache unauth, {}'.format(addr))
                tqdm.write(Fore.RED + '[+] target maybe memcache unauth, {}'.format(addr))
                return {'name': 'unauth', 'url': str(addr), 'software': 'memcache'}
    except Exception:
        pass
    finally:
        try:
            writer.close()
        except NameError:
            pass


async def memcacheScan(addr, pbar):
    vulList = []
    a = await checkUnauth(addr)
    if a is not None:
        vulList.append(a)
    pbar.update(1)
    return vulList
